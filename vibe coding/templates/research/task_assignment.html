{% extends 'base.html' %}
{% load static %}

{% block title %}教学任务分配{% endblock %}
{% block page_title %}{% endblock %}
{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/research.css' %}">
{% endblock %}

{% block content %}

<!-- 跨页 Tab 导航：任务分配 | 质量监控（恢复按钮，仅保留按钮，不要多余文字header） -->
<!-- 已移除：通过侧栏导航切换 -->

<div class="research-container">
  <div class="module-tabs">
    <div class="tabs">
      <div class="tab-header">
        <button class="tab-button active" data-tab="manualTab" type="button">手动批量分配</button>
        <button class="tab-button" data-tab="historyTab" type="button">从历史记录里分配</button>
      </div>

      <!-- 手动批量分配 -->
      <div id="manualTab" class="tab-pane active">
        <!-- 教师任务统计（整块删除） -->
        <!-- <div class="teacher-stats">...</div> -->

        <!-- 老师选择区域 -->
        <div class="teacher-selection">
          <h3>1. 选择分配老师</h3>
          <div class="teacher-buttons">
            {% for teacher in teachers %}
            <button class="teacher-btn" data-teacher="{{ teacher.id }}" data-teacher-name="{{ teacher.real_name|default:teacher.username }}">{{ teacher.real_name|default:teacher.username }}</button>
            {% endfor %}
          </div>
        </div>

        <!-- 学员分配区域 -->
        <div class="student-assignment">
          <div class="assignment-header">
            <h3>2. 添加学员并分配任务</h3>
            <span id="selectedTeacherDisplay" style="color: #3498db; font-weight: 500;">请先选择老师</span>
          </div>

          <!-- 替换为“参考教学/运营”的标准搜索栏 -->
          <div class="ops-search">
            <div class="search-input-group">
              <span class="search-icon"> </span>
              <input type="text" id="assignment-search" class="search-input" placeholder="搜索学员昵称、备注名、用户ID...">
            </div>
            <button type="button" class="btn btn-primary" id="assignment-search-btn">搜索</button>
          </div>
          <div id="assignment-search-results" class="table-container"></div>

          <!-- 选中学员 -> 转为任务列表（每条任务内可填写备注意见等） -->
          <div class="selected-students" id="selectedStudents">
            <div style="padding: 20px; text-align: center; color: #999;">暂无选择的任务</div>
          </div>

          <!-- 全局任务备注输入栏（已删除，备注移到每个任务里去） -->
          <!-- <div class="task-note-section">...</div> -->
        </div>

        <!-- 操作按钮 -->
        <div class="action-buttons">
          <button class="btn btn-primary" onclick="saveAssignment()">保存分配</button>
          <button class="btn btn-warning" onclick="clearAssignment()">清空分配</button>
          <!-- 导出结果按钮移至分配记录区域 -->
        </div>
      </div>

      <!-- 从历史记录里分配（按老师为集合展示） -->
      <div id="historyTab" class="tab-pane">
        <div class="history-selection">
          <h3>按老师聚合的历史分配记录</h3>
          <div class="history-list" id="historyList">
            <div style="padding: 20px; text-align: center; color: #999;">正在加载历史记录...</div>
          </div>
          <div class="history-actions">
            <!-- 删除使用选中记录按钮 -->
            <!-- <button class="btn btn-success" onclick="useSelectedHistory()">使用选中记录</button> -->
            <button class="btn btn-warning" onclick="editSelectedHistory()">编辑后使用</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- 数据传递给JavaScript -->
<script>
window.djangoData = {
  teachers: {{ teachers_json|default:'[]'|safe }},
  students: {{ students_json|default:'[]'|safe }},
  csrfToken: '{{ csrf_token }}',
  urls: {
    searchStudents: '{% url "research:search_students" %}',
    createTask: '{% url "research:create_task_assignment" %}',
    taskHistory: '{% url "research:task_history" %}',
    taskHistoryApi: '{% url "research:get_task_history_api" %}',
    exportResults: '{% url "research:export_assignment_results" %}',
    getTaskDetail: '{% url "research:get_task_detail" task_id=0 %}',
    useHistory: '{% url "research:use_history_assignment" task_id=0 %}',
    getTeacherStats: '{% url "research:get_teacher_stats" %}',
    studentDetail: '{% url "research:student_detail" student_id=0 %}'
  }
};
</script>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/searchBar.js' %}"></script>
<script src="{% static 'js/research.js' %}"></script>
{% endblock %}