{% extends 'base.html' %}
{% load static %}

{% block title %}æ•™å¸ˆç‚¹è¯„ - ç¿æ¶µéŸ³ä¹åå°{% endblock %}

{% block page_title %}å­¦å‘˜ç‚¹è¯„{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/teaching.css' %}">
{% endblock %}

{% block content %}
<div class="teaching-container">
    <!-- å…¬å‘Šæ  -->
    <div class="announcement-bar">
        <div class="announcement-content">
            <span class="announcement-icon">ğŸ“¢</span>
            <span class="announcement-text">ä»Šæ—¥éœ€è¦ç‚¹è¯„çš„å­¦å‘˜ï¼š{{ today_tasks|length }} äºº</span>
        </div>
    </div>
    
    <!-- æ¨¡å—æ ‡ç­¾é¡µ -->
    <div class="module-tabs">
        <button class="tab-button active" data-tab="todayTasks">ä»Šæ—¥ä»»åŠ¡</button>
        <button class="tab-button" data-tab="completedComments">å·²ç‚¹è¯„è®°å½•</button>
        <button class="tab-button" data-tab="manualComment">æ‰‹åŠ¨ç‚¹è¯„</button>
    </div>
    
    <!-- ä»Šæ—¥ä»»åŠ¡æ ‡ç­¾é¡µ -->
    <div id="todayTasks" class="tab-pane active">
        <div class="action-bar">
            <div class="batch-actions">
                <label class="checkbox-container">
                    <input type="checkbox" id="selectAll">
                    <span class="checkmark"></span>
                    å…¨é€‰
                </label>
                <button id="pushToResearch" class="btn btn-warning" disabled>æ¨é€åˆ°æ•™ç ”</button>
                <button id="pushToOperation" class="btn btn-info" disabled>æ¨é€åˆ°è¿è¥</button>
                <button id="batchDelete" class="btn btn-danger" disabled>æ‰¹é‡åˆ é™¤</button>
            </div>
            <button id="refreshTasks" class="btn btn-primary">åˆ·æ–°ä»»åŠ¡</button>
        </div>
        
        <div class="task-list">
            {% for task in today_tasks %}
            <div class="task-item">
                <div class="task-header">
                    <label class="checkbox-container">
                        <input type="checkbox" class="task-checkbox" data-student-id="{{ task.student.student_id }}">
                        <span class="checkmark"></span>
                    </label>
                    <div class="student-info">
                        <span class="student-name">{{ task.student.student_name }}</span>
                        {% if task.student.alias_name %}
                            <span class="student-alias">({{ task.student.alias_name }})</span>
                        {% endif %}
                        <span class="student-group">{{ task.student.group_name }}</span>
                        {% if task.is_difficult %}
                            <span class="difficulty-badge">å›°éš¾å­¦ç”Ÿ</span>
                        {% endif %}
                    </div>
                    <button class="btn-view-info" onclick="viewStudentInfo('{{ task.student.student_id }}')">æŸ¥çœ‹ä¿¡æ¯</button>
                </div>
                
                <div class="task-content">
                    <div class="input-group">
                        <label>è¯¾ç¨‹è¿›åº¦ï¼š</label>
                        <input type="number" class="lesson-input" data-student-id="{{ task.student.student_id }}" placeholder="ç¬¬å‡ è¯¾">
                    </div>
                    <div class="input-group">
                        <label>æ•™å¸ˆç‚¹è¯„ï¼š</label>
                        <textarea class="comment-input" placeholder="è¯·è¾“å…¥ç‚¹è¯„å†…å®¹..."></textarea>
                    </div>
                </div>
            </div>
            {% empty %}
            <div class="empty-state">
                <div class="empty-state-icon">âœ…</div>
                <p>ä»Šæ—¥æš‚æ— å¾…ç‚¹è¯„ä»»åŠ¡</p>
            </div>
            {% endfor %}
        </div>
        
        {% if today_tasks %}
        <div class="submit-section">
            <button id="submitComments" class="btn btn-success btn-large">æäº¤ç‚¹è¯„</button>
        </div>
        {% endif %}
    </div>
    
    <!-- å·²ç‚¹è¯„è®°å½•æ ‡ç­¾é¡µ -->
    <div id="completedComments" class="tab-pane">
        <div class="completed-section">
            <table class="table">
                <thead>
                    <tr>
                        <th>å­¦å‘˜æ˜µç§°</th>
                        <th>è¯¾ç¨‹è¿›åº¦</th>
                        <th>æ•™å¸ˆç‚¹è¯„</th>
                        <th>ç‚¹è¯„æ—¶é—´</th>
                    </tr>
                </thead>
                <tbody id="completedList">
                    {% for feedback in completed_feedbacks %}
                    <tr class="completed-item">
                        <td class="completed-student">{{ feedback.student.student_name }}</td>
                        <td class="completed-progress">ç¬¬{{ feedback.lesson_number }}è¯¾</td>
                        <td class="completed-comment">{{ feedback.teacher_comment }}</td>
                        <td class="completed-time">{{ feedback.created_at|date:"Y-m-d H:i" }}</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="4">
                            <div class="empty-state">
                                <div class="empty-state-icon">ğŸ“</div>
                                <p>æš‚æ— å·²ç‚¹è¯„è®°å½•</p>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- æ‰‹åŠ¨ç‚¹è¯„æ ‡ç­¾é¡µ -->
    <div id="manualComment" class="tab-pane">
        <div class="manual-search">
            <div class="search-group">
                <input type="text" id="studentSearch" class="search-input" placeholder="è¯·è¾“å…¥å­¦å‘˜æ˜µç§°æœç´¢...">
            </div>
            
            <div id="manualEmptyState" class="empty-state">
                <div class="empty-state-icon">ğŸ”</div>
                <p>è¯·è¾“å…¥å­¦å‘˜æ˜µç§°å¼€å§‹æœç´¢</p>
            </div>
            
            <form id="manualCommentForm" class="manual-form" style="display: none;">
                {% csrf_token %}
                <div class="form-group">
                    <label class="form-label">è¯¾ç¨‹è¿›åº¦</label>
                    <input type="number" id="manualLessonNumber" class="form-input" placeholder="ç¬¬å‡ è¯¾" required>
                </div>
                <div class="form-group">
                    <label class="form-label">æ•™å¸ˆç‚¹è¯„</label>
                    <textarea id="manualTeacherComment" class="form-textarea" placeholder="è¯·è¾“å…¥ç‚¹è¯„å†…å®¹..." required></textarea>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">æäº¤ç‚¹è¯„</button>
                    <button type="button" class="btn btn-secondary" onclick="cancelManualComment()">å–æ¶ˆ</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- æ¨é€æ¨¡æ€æ¡† -->
<div id="pushModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="pushModalTitle">æ¨é€åˆ°éƒ¨é—¨</h2>
            <span class="close" onclick="closePushModal()">&times;</span>
        </div>
        <div class="form-group">
            <label class="form-label" id="pushModalLabel">å¤‡æ³¨ä¿¡æ¯</label>
            <textarea class="form-input form-textarea" id="pushNote" placeholder="è¯·è¾“å…¥å¤‡æ³¨ä¿¡æ¯..."></textarea>
        </div>
        <div class="action-bar">
            <button class="btn btn-primary" onclick="confirmPush()">ç¡®è®¤æ¨é€</button>
            <button class="btn btn-secondary" onclick="closePushModal()">å–æ¶ˆ</button>
        </div>
    </div>
</div>

<!-- å­¦å‘˜ä¿¡æ¯æ¨¡æ€æ¡† -->
<div id="studentModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>å­¦å‘˜ä¿¡æ¯</h2>
            <span class="close" onclick="closeStudentModal()">&times;</span>
        </div>
        <div id="studentModalContent">
            <!-- å­¦å‘˜è¯¦ç»†ä¿¡æ¯å°†é€šè¿‡AJAXåŠ è½½ -->
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/teaching.js' %}"></script>
{% endblock %}