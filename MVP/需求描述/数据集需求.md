# 数据模型设计文档（与当前实现对齐）

---

## 1. Feedback 数据集（apps.teaching.models.Feedback）
教师对学员点评和任务回复的记录。

- 字段
  - id：自动主键
  - reply_time：datetime，自动生成，点评时间
  - user_id：string，业务学员ID（对应 Student.student_id）
  - student：ForeignKey(Student)
  - student_name：string，学员昵称（冗余，便于展示）
  - progress_json：Text，JSON 数组，学习进度（如 [6, 6.2, 7]）；模型提供 property `progress` 读写为 Python 列表
  - teacher_name：string，回复教师姓名
  - teacher：ForeignKey(User)
  - teacher_comment：Text，教师评语（可空）
  - push_research：Text，推送教研备注（可空）
  - push_ops：Text，推送运营备注（可空）
  - course_name：string（可空）
  - course_progress：int，默认 0
  - is_featured：bool，是否精选，默认 False
  - created_at：datetime，创建时间
  - updated_at：datetime，更新时间
- 索引
  - (student, reply_time)
  - (teacher, reply_time)
- 行为
  - save() 时将 `student.progress` 同步为本条 feedback 的 `progress`（由 `progress_json` 反序列化）。

---

## 2. Student 数据集（apps.students.models.Student）
学员的基本信息、状态和跨部门备注。

- 字段
  - id：自动主键
  - student_id：string，唯一，业务学员ID
  - external_user_id：string，唯一，小鹅通ID
  - student_name：string，学员昵称
  - alias_name：string，备注名（可空）
  - groups_json：Text，JSON 数组，学员分组；提供 property `groups` 以 list 读写
  - progress_json：Text，JSON 数组，学习进度；提供 property `progress` 以 list 读写，并在 setter 中更新 `learning_progress`
  - status：enum（joined/active/graduated/archived），默认 joined
  - learning_hours：float，累计学习时长
  - research_note：Text，教研备注（可空）
  - ops_note：Text，运营备注（可空）
  - is_difficult：bool，是否需要关注，默认 False
  - assigned_teacher：ForeignKey(User，可空)，分配教师
  - difficulty_source：enum（system/teacher/manual，可空），困难来源
  - learning_status：enum（normal/attention/excellent/new），默认 normal
  - learning_progress：int，从 `progress_json` 推导的当前进度（课程数）
  - total_study_time：float，总学习时长
  - created_at：datetime，注册时间
  - updated_at：datetime，更新时间
- 索引
  - student_name、external_user_id、status、learning_status、is_difficult
- 说明
  - `groups_json` 与 `progress_json` 为事实源，分别通过 `groups` 与 `progress` 属性以 Python 列表方式读写。
  - `learning_progress` 由 `progress` 的最新值或兜底策略推导；`course_progress` 为便捷百分比属性（非持久化字段）。

---

## 3. OpsTask 数据集（apps.operations.models.OpsTask，运营待办事项）
运营侧对需要跟进学员的待办任务。

- 字段
  - id：自动主键
  - task_id：string，唯一任务ID
  - student：ForeignKey(Student)
  - student_name：string，学员昵称（冗余，便于列表展示）
  - visit_count：int，回访次数，默认 0
  - source：enum（teacher/system/research/manual），推送来源
  - task_status：enum（pending/contacted/no_reply/closed），默认 pending
  - created_at：datetime
  - updated_at：datetime
- 索引
  - (student, task_status)
  - (source, created_at)
- 说明
  - 学员的分组/状态/进度来自关联 Student，不在本表冗余存储。

---

## 4. VisitRecord 数据集（apps.operations.models.VisitRecord，回访记录）
运营或老师的回访操作历史。

- 字段
  - id：自动主键
  - record_id：string，唯一记录ID
  - student：ForeignKey(Student)
  - student_name：string，学员昵称（冗余，便于展示）
  - visit_time：datetime，自动填充为当前时间
  - visit_status：enum（pending/contacted/no_reply/closed）
  - visit_count：int，累计回访次数
  - teacher_name：string，任课老师
  - visit_note：Text，回访记录文本
  - created_at：datetime
  - updated_at：datetime
- 索引
  - (student, visit_time)
  - (visit_status, visit_time)

---

## 5. 系统角色
- 教师（teacher）：点评、推送运营/教研备注
- 运营（运营）：维护学员基础信息，管理运营待办与回访记录
- 教研（researcher）：任务分配、教学质量控制，更新学员困难/异常备注

---

## 6. 数据关系与同步
- Student : Feedback = 1 : N（同时保留 `Feedback.user_id` 业务键）
- Student : OpsTask = 1 : N
- Student : VisitRecord = 1 : N
- `Student.progress_json` 为事实源，由 `Feedback.save()` 在点评提交后自动同步更新；`learning_progress` 与之保持一致。

