{% extends 'base.html' %}
{% load static %}

{% block title %}教学任务分配{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/research.css' %}">
{% endblock %}

{% block content %}
<div class="header">
    <h2>教学任务分配</h2>
</div>

<div class="content">
    <!-- 功能选择区域 -->
    <div class="function-tabs">
        <h3>选择分配方式</h3>
        <div class="tab-buttons">
            <button class="tab-btn active" data-tab="manual">手动批量分配</button>
            <button class="tab-btn" data-tab="history">从历史记录里分配</button>
        </div>
    </div>
    
    <!-- 手动批量分配 -->
    <div id="manual-tab" class="tab-content active">
        <!-- 教师统计信息 -->
        <div class="teacher-stats">
            <h3>教师任务统计</h3>
            <div class="stats-grid">
                <!-- 统计信息将通过JavaScript动态更新 -->
            </div>
        </div>
        
        <!-- 老师选择区域 -->
        <div class="teacher-selection">
            <h3>1. 选择分配老师</h3>
            <div class="teacher-buttons">
                {% for teacher in teachers %}
                <button class="teacher-btn" data-teacher="{{ teacher.username }}">{{ teacher.username }}</button>
                {% endfor %}
            </div>
        </div>
        
        <!-- 学员分配区域 -->
        <div class="student-assignment">
            <div class="assignment-header">
                <h3>2. 添加学员并分配任务</h3>
                <span id="selected-teacher-display" style="color: #3498db; font-weight: 500;">请先选择老师</span>
            </div>
            
            <div class="student-input-section">
                <input type="text" class="student-input" id="student-search" placeholder="输入学员姓名进行搜索..." autocomplete="off">
                <div class="student-suggestions" id="student-suggestions"></div>
            </div>
            
            <div class="selected-students" id="selected-students">
                <div style="padding: 20px; text-align: center; color: #999;">暂无选择的学员</div>
            </div>
        </div>
        
        <!-- 操作按钮 -->
        <div class="action-buttons">
            <button class="btn btn-primary" onclick="confirmAssignment()">确认分配</button>
            <button class="btn btn-warning" onclick="finishAssignment()">分配结束</button>
            <button class="btn btn-secondary" onclick="exportResults()">导出结果</button>
        </div>
    </div>
    
    <!-- 从历史记录里分配 -->
    <div id="history-tab" class="tab-content">
        <div class="history-selection">
            <h3>选择历史分配记录</h3>
            <div class="history-list" id="history-list">
                <div style="padding: 20px; text-align: center; color: #999;">正在加载历史记录...</div>
            </div>
            <div class="history-actions">
                <button class="btn btn-success" onclick="useSelectedHistory()">使用选中记录</button>
                <button class="btn btn-warning" onclick="editSelectedHistory()">编辑后使用</button>
            </div>
        </div>
    </div>
    
    <!-- 任务分配记录 -->
    <div class="assignment-records">
        <div class="records-header">
            <h3>分配记录</h3>
            <div class="records-controls">
                <span style="font-size: 14px; color: #666;">按老师排序</span>
                <button class="btn-clear" onclick="clearAllRecords()">清空记录</button>
            </div>
        </div>
        
        <div class="records-list" id="records-list">
            <div class="no-records">暂无分配记录</div>
        </div>
    </div>
</div>

<!-- 学员详情模态框 -->
<div id="student-detail-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>学员详情</h3>
            <span class="close" onclick="closeModal('student-detail-modal')">&times;</span>
        </div>
        <div class="student-detail" id="student-detail-content">
            <!-- 学员详情内容将在这里动态加载 -->
        </div>
    </div>
</div>

<!-- 数据传递给JavaScript -->
<script>
window.djangoData = {
    teachers: {{ teachers|safe }},
    students: {{ students|safe }},
    csrfToken: '{{ csrf_token }}',
    urls: {
        searchStudents: '{% url "research:search_students" %}',
        createTask: '{% url "research:create_task_assignment" %}',
        taskHistory: '{% url "research:task_history" %}',
        exportResults: '{% url "research:export_assignment_results" %}',
        getTaskDetail: '{% url "research:get_task_detail" task_id=0 %}',
        useHistory: '{% url "research:use_history_assignment" task_id=0 %}',
        getTeacherStats: '{% url "research:get_teacher_stats" %}'
    }
};
</script>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/research.js' %}"></script>
{% endblock %}